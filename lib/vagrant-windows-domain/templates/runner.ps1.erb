function Test-PartOfDomain($computerName, $domain){
	$computerSystem = gwmi win32_computersystem
	return ($computerSystem.Name -eq $computerName) -and ($computerSystem.PartOfDomain) -and ($computerSystem.Domain -eq $domain) 
}

function Test-JoinedToADomain(){
	$computerSystem = gwmi win32_computersystem
	return $computerSystem.PartOfDomain
}

function Repair-OpenSSHPasswd(){
	$passwdPath = 'C:\Program Files\OpenSSH\etc\passwd'
	$mkpasswdPath = 'C:\Program Files\OpenSSH\bin\mkpasswd.exe'
	if ((Test-Path $passwdPath) -and (Test-Path $mkpasswdPath)){
		$passwd = &$mkpasswdPath
		$passwd = $passwd -replace '^([^+]*\+)', ''
		$passwd | Set-Content $passwdPath -Encoding Ascii
	}
}
<% if options[:computer_name] != nil %>
$computerName='<%= options[:computer_name] %>'
<% else %>
$computerName = $env:COMPUTERNAME
<% end %>
<% if options[:username] != nil && options[:unsecure] != true %>
$domain='<%= options[:domain] %>'
$username='<%= options[:username] %>'
$password='<%= options[:password] %>'
$secpasswd = ConvertTo-SecureString $password -AsPlainText -Force
$credentials = New-Object System.Management.Automation.PSCredential ($username, $secpasswd)
<% end %>
<% if options[:add_to_domain] === true %>
if (Test-PartOfDomain -computerName $computerName -domain $domain){
	throw "$computerName already part of domain $domain"
} else {
	#If a value is provided for the Primary_DNS variable in the vagrantfile, powershell will attempt to determine if the string is a valid IP and will statically set the primary dns server of the vm's nic if it is.
	<% if options[:primary_dns] != nil %>
		$prim = '<%= options[:primary_dns] %>'
		If ($prim -match "^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$")
		{
			$wmi = Get-WmiObject -ComputerName $env:COMPUTERNAME -Namespace "root\CIMV2" -Class "Win32_NetworkAdapterconfiguration" -Filter 'IPENABLED=TRUE' -Impersonation Impersonate -ErrorAction Stop | Where-Object { $_.DefaultIPGateway }
			$currdns = $wmi.DNSServerSearchOrder
			$wmi.SetDNSServerSearchOrder(@($prim, $currdns[1]))
		}
		else
		{
			throw "Invalid IP address provided"
		}
	<% end %>

	#If a value is provided for the Secondary_DNS variable in the vagrantfile, powershell will attempt to determine if the string is a valid IP and will statically set the secondary dns server of the vm's nic if it is.
	<% if options[:secondary_dns] != nil %>
		$sec = '<%= options[:secondary_dns] %>'
		If ($sec -match "^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$")
		{
			$wmi = Get-WmiObject -ComputerName $env:COMPUTERNAME -Namespace "root\CIMV2" -Class "Win32_NetworkAdapterconfiguration" -Filter 'IPENABLED=TRUE' -Impersonation Impersonate -ErrorAction Stop | Where-Object { $_.DefaultIPGateway }
			$currdns = $wmi.DNSServerSearchOrder
			$wmi.SetDNSServerSearchOrder(@($currdns[0], $sec))
		}
		else
		{
			throw "Invalid IP address provided"
		}
	<% end %>

	Add-Computer <%= options[:parameters] %> -Verbose -Force -PassThru

	# Rename computer separately: Fixes GH issue #11
	<% if options[:computer_name] != nil %>
	$completed = $false
	while ( -not $completed) {
		try {
			Rename-Computer <%= options_rename[:parameters] %> -Verbose -Force -ErrorAction Stop
			$completed = $true
		} catch {
			if ($retrycount -ge 5) {
				Write-Host ("Rename failed the maximum number of $retrycount times.")
				throw
			} else {
				Write-Host ("Rename failed, Retrying in 5 seconds...")
				Start-sleep -s 5
				$retrycount++
			}
		}
	}
	<% end %>	
	
	Repair-OpenSSHPasswd

	# Fix vagrant-windows GH-129, if there's an existing scheduled
	# reboot cancel it so shutdown succeeds
	#&shutdown /a

	# Force shutdown the machine now
	&shutdown /r /t 0 /c "Vagrant Halt" /f /d p:4:1	
}
<% else %>
if (!(Test-JoinedToADomain)) {
	Throw "$computerName not part of any domain"
} else {
	Remove-Computer <%= options[:parameters] %> -Workgroup 'WORKGROUP' -Verbose -Force -PassThru
	Repair-OpenSSHPasswd
	#removed the shutdown of the vm when disjoining it from the domain since, as the vm is about to be destroyed anyway, so there is no use for it.
	# Fix vagrant-windows GH-129, if there's an existing scheduled
	# reboot cancel it so shutdown succeeds
	#&shutdown /a

	# Force shutdown the machine now
	&shutdown /r /t 0 /c "Vagrant Halt" /f /d p:4:1
}
<% end %>
